Summary of TLS Profile protocol
===============================

There are three actors:
  - the Web Application
       (web page served by https and executing in a browser on the local host)
  - the TLS Profile Hub component
       (running as part of the Hub on the local host)
  - the Relay
       (running independently on some external host, possibly the same
       one that served the Web Application)

The following sections describe the required behaviour of each actor.

Web application:
----------------
   Knows location of HTTPS XML-RPC Relay service.

   Makes XML-RPC calls to Relay URL exactly as for Web Profile.
   However, every time it makes any XML-RPC call to the Relay URL,
   it additionally requests an image (by manipulating the src
   attribute of an HTML IMG element) with the URL:

       http://localhost:21013/nudge?relay=relayUrl

   URL translation (REC-SAMP-1.3 sec 5.2.6): doesn't work.

Relay:
------
   Runs XML-RPC service at endpoint known to web application.

   samp.webhub.* XML-RPC calls:
      Each such call is collected and recorded by the hostname of the
      HTTP request.  It is dispensed to a hub from the same hostname
      on request (by a samp.tlsfwd.pullCalls).
      When the corresponding samp.tlsfwd.receiveResult (matched by callTag)
      is received, the result is returned (synchronously) as the
      result of this XML-RPC call.

      These calls are identical to the Hub API for the Web Profile,
      though the relay is not required or expected to examine their
      content at all.

   samp.tlsfwd.* XML-RPC calls:
      ping():
         Any non-error response indicates relay is running

      list pullCalls(string timeoutSec):
         Long poll for pending relayed calls.

         The relay must return a serialization of all calls
         submitted so far (and not previously returned by a previous
         invocation of this method) by the same host as is performing
         this call.  The host is identified directly from the incoming
         HTTP request in both cases.

         timeoutSec is a SAMP integer giving the maximum wait time
         in seconds.

         The return value is a (possibly empty) list of maps,
         each representing an XML-RPC call from the SAMP hub API,
         to be executed by the hub (cf. REC-SAMP-1.3 sec 5.2.5).

         Each map represents a submitted samp.webhub.* call, with keys:
             samp.methodName
                XML-RPC method name as received
             samp.params
                XML-RPC parameter list as received
             samp.callTag
                unique identifier for call, used to associate this call
                with a later response, generated by relay.
             samp.referer
                content of HTTP "Referer" header accompanying submitted
                XML-RPC request

      receiveResult(string callTag, map result):
         Receives results of XML-RPC hub API calls previously dispensed
         by the pullCalls method.

         The relay expects to receive exactly one receiveResult call
         for each item in the pullCalls list it has dispensed,
         though it may time out after a long time if none is received.

         The callTag parameter is that from a previously dispensed call.
         The result parameter is a map, with keys:
             samp.value:
                return value of the method, if success
             samp.error:
                text of an error report, if failure
         Exactly one of these keys must be present.


TLS Profile Hub:
----------------
   Runs HTTP server on port 21013.

   Services requests of the form GET /nudge?param=value&param=value&...

   If one of the parameters is "relay":
      Treat the corresponding value as the URL of a TLS profile Relay.
      Ignore any other parameters.  The synchronous HTTP response is
      200 with a small image, possibly indicating some activity.

      Asynchronously invoke pullCalls on the relay at that URL to
      obtain any calls that are pending now or within a few seconds
      after now.  Service all those pending calls and return the
      results to the Relay using the Relay XML-RPC API.

      Servicing the calls should be done in the same way as for the
      Web Profile, except that the information displayed to be displayed
      during user confirmation of registration (REC-SAMP-1.3 sec 5.4.2.2)
      should include the identity of the hub relay from which the
      registration request was retrieved, as well as the content of
      the samp.referer header included in that serialised call.
 
   If there are no parameters:
      The synchronous HTTP response is 200 with a small image,
      possibly indicating no activity.

   If there are parameters but none of them is "relay":
      The synchronous HTTP error response is 400.

   HTTP 200 responses:
      Should have header "Cache-Control: no-cache".
      Content-Type should be image/png or image/gif or image/jpeg.
      Image size should be small, and always the same.

   HTTP nudge requests may be rejected according to host; it is recommended
   that requests from non-localhost should be rejected (see REC-SAMP-1.3
   sec 5.4.2.1).

   Requests to paths other than /nudge should return 404.


